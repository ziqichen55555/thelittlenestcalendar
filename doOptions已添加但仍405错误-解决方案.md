# 🔧 doOptions 已添加但仍 405 错误 - 解决方案

## ⚠️ 问题

你已经添加了 `doOptions` 函数，但仍然出现 405 错误。这说明部署可能没有生效。

## ✅ 解决方案

### 方法 1：删除旧部署，创建新部署（推荐）

有时候编辑现有部署可能不会完全生效，删除后重新创建更可靠：

#### 步骤 1：删除旧部署

1. **打开 Google Apps Script**：https://script.google.com/
2. **点击 "部署" → "管理部署"**
3. **找到现有的部署**
4. **点击右侧的 "删除" 按钮**（垃圾桶图标）
5. **确认删除**

#### 步骤 2：创建新部署

1. **点击 "部署" → "新建部署"**
2. **点击 "选择类型" → "网页应用"**
3. **设置**：
   - **说明**：`The Little Nest Calendar API v2`
   - **执行身份**：选择 **"我"**
   - **具有访问权限的用户**：选择 **"所有人"** ✅（重要！）
4. **点击 "部署"**
5. **复制新的 Web App URL**

#### 步骤 3：更新应用代码

如果 URL 改变了，告诉我新的 URL，我会更新应用代码。

### 方法 2：确认使用最新版本

#### 步骤 1：检查部署版本

1. **打开 Google Apps Script**
2. **点击 "部署" → "管理部署"**
3. **查看部署列表**：
   - 确认使用的是最新版本
   - 查看 "最后更新" 时间

#### 步骤 2：强制使用新版本

1. **点击部署的 "编辑"**（铅笔图标）
2. **在 "版本" 下拉菜单中**：
   - 如果显示 "新版本"，选择它
   - 如果显示版本号（如 "1"），也选择 "新版本"
3. **确认 "具有访问权限的用户" = "所有人"**
4. **点击 "部署"**

### 方法 3：验证代码确实已保存

#### 步骤 1：检查代码

1. **在 Google Apps Script 编辑器中**
2. **按 `Ctrl+F` 或 `Cmd+F` 搜索**：`doOptions`
3. **确认能找到函数**
4. **确认函数在文件最前面**（在 `doGet` 之前）

#### 步骤 2：确认代码已保存

1. **查看编辑器顶部**
2. **确认没有未保存的更改**（没有星号 *）
3. **如果有，点击 "保存"**

### 方法 4：测试 doOptions 函数

#### 步骤 1：手动测试 OPTIONS 请求

1. **打开浏览器开发者工具**（F12）
2. **切换到 Network 标签**
3. **在控制台运行**：
   ```javascript
   fetch('https://script.google.com/macros/s/AKfycbxsJMmHKtlQwn7wqFX3T6xRP96gDM8UdJp5MoZ2Q31_RSlOZTHLTlqoEAkfB8oZecY-Jw/exec', {
     method: 'OPTIONS'
   }).then(r => console.log('OPTIONS 状态:', r.status))
   ```
4. **查看结果**：
   - ✅ **200** = `doOptions` 工作正常
   - ❌ **405** = `doOptions` 没有生效

## 🔍 常见问题

### 问题 1：部署后 URL 没有改变

**原因**：编辑现有部署时，URL 通常不会改变。

**解决**：这是正常的，只要重新部署了，代码就会更新。

### 问题 2：部署了但还是 405

**可能原因**：
1. 代码没有正确保存
2. 使用的是旧版本部署
3. 浏览器缓存

**解决**：
1. 确认代码已保存
2. 删除旧部署，创建新部署
3. 清除浏览器缓存

### 问题 3：doOptions 函数位置不对

**要求**：`doOptions` 函数必须在文件最前面（在 `doGet` 和 `doPost` 之前）

**检查**：
```javascript
// ✅ 正确顺序
const SHEET_NAME = "thelittlenestbookings";

function doOptions() { ... }  // 在最前面

function doGet() { ... }

function doPost(e) { ... }
```

## 📋 完整验证清单

- [ ] `doOptions` 函数存在于代码中（搜索能找到）
- [ ] `doOptions` 函数在文件最前面（在 `doGet` 之前）
- [ ] 代码已保存（没有未保存的更改）
- [ ] 已删除旧部署，创建新部署（或已重新部署为新版本）
- [ ] "具有访问权限的用户" = "所有人"
- [ ] 已等待 10-20 秒让部署生效
- [ ] 已刷新应用页面（硬刷新：`Ctrl+Shift+R`）
- [ ] 手动测试 OPTIONS 请求返回 200（不是 405）

## 🎯 推荐操作

**最快的方法**：

1. **删除现有部署**
2. **创建新部署**（确保 "具有访问权限的用户" = "所有人"）
3. **等待 10-20 秒**
4. **刷新应用页面**（硬刷新）
5. **测试添加预订**

## 📞 如果还是不行

如果按照上述步骤操作后仍然有 405 错误：

1. **手动测试 OPTIONS 请求**（见方法 4）
2. **如果返回 405**：说明 `doOptions` 确实没有生效
3. **提供信息**：
   - Google Apps Script 代码截图（显示前 30 行）
   - 部署设置截图
   - 手动测试 OPTIONS 的结果


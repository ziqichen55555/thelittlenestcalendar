# 🚨 立即修复 CORS 错误 - 详细步骤

## ⚠️ 问题

删除功能失败，出现 CORS 错误。这是因为 Google Apps Script 缺少 `doOptions` 函数来处理 CORS 预检请求。

## ✅ 解决方案（5 分钟完成）

### 步骤 1：打开 Google Apps Script

1. 访问：https://script.google.com/
2. 选择你的项目（The Little Nest Calendar 或类似名称）

### 步骤 2：复制完整代码

1. **打开文件**：`立即修复CORS-完整代码.js`
2. **复制整个文件的内容**（从第一行到最后一行）
3. **回到 Google Apps Script 编辑器**

### 步骤 3：替换代码

1. **在 Google Apps Script 编辑器中**：
   - 选中所有现有代码（`Ctrl+A` 或 `Cmd+A`）
   - **删除**所有代码
   - **粘贴**刚才复制的完整代码

2. **确认代码包含**：
   - ✅ `doOptions` 函数（在文件开头）
   - ✅ `doGet` 函数
   - ✅ `doPost` 函数

### 步骤 4：保存

1. 点击 **"保存"** 按钮（💾 图标）或按 `Ctrl+S` (Windows) / `Cmd+S` (Mac)
2. 确认没有错误提示

### 步骤 5：重新部署（重要！）

1. 点击 **"部署"** → **"管理部署"**
2. 找到现有的部署，点击 **"编辑"**（铅笔图标）
3. 在 "版本" 下拉菜单中选择 **"新版本"**
4. **重要**：确认 "具有访问权限的用户" 设置为 **"所有人"**
5. 点击 **"部署"** 按钮
6. 等待部署完成（几秒钟）

### 步骤 6：测试

1. **等待 10-20 秒**让部署生效
2. **刷新你的日历应用页面**（硬刷新：`Ctrl+Shift+R` 或 `Cmd+Shift+R`）
3. **尝试删除一个预订**
4. **如果成功**：✅ 问题解决！
5. **如果还是失败**：查看下面的故障排除

## 🔍 关键点

### 1. `doOptions` 函数必须存在

这是修复 CORS 错误的关键。函数应该在最前面：

```javascript
function doOptions() {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.JSON);
}
```

### 2. 部署设置必须正确

- **"具有访问权限的用户"** = **"所有人"** ✅
- 这会让 Google Apps Script 自动处理 CORS

### 3. 必须使用新版本部署

- 不能只保存代码
- 必须重新部署为新版本
- 否则更改不会生效

## ❓ 故障排除

### 如果还是出现 CORS 错误

1. **确认 `doOptions` 函数存在**：
   - 在 Google Apps Script 编辑器中
   - 查看代码，确认有 `doOptions` 函数

2. **确认部署设置**：
   - "具有访问权限的用户" = "所有人"
   - 使用的是最新版本

3. **清除浏览器缓存**：
   - 硬刷新：`Ctrl+Shift+R` 或 `Cmd+Shift+R`
   - 或使用无痕模式测试

4. **检查浏览器控制台**：
   - 打开控制台（F12）
   - 查看详细的错误信息
   - 确认错误类型

### 如果看到其他错误

- **"Sheet not found"**：检查 Google Sheet 中是否有 `thelittlenestbookings` 工作表
- **"ID is required"**：这是正常的验证，确保传递了 ID
- **网络错误**：检查网络连接和 Google Apps Script URL

## 📝 验证清单

更新后，确认：

- [ ] `doOptions` 函数已添加到代码中
- [ ] 代码已保存
- [ ] 已重新部署为新版本
- [ ] "具有访问权限的用户" = "所有人"
- [ ] 已等待 10-20 秒让部署生效
- [ ] 已刷新应用页面（硬刷新）
- [ ] 已测试删除功能

## 🎯 完成

如果所有步骤都正确执行，删除功能应该可以正常工作，不再出现 CORS 错误。

## 📞 需要帮助？

如果按照上述步骤操作后仍然有 CORS 错误，请提供：
1. 浏览器控制台的完整错误信息
2. Google Apps Script 代码截图（确认有 `doOptions` 函数）
3. 部署设置的截图（确认 "具有访问权限的用户" = "所有人"）


<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éªŒè¯ Web App éƒ¨ç½²</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
    .warning h3 {
      margin-top: 0;
      color: #856404;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #5568d3;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      font-weight: bold;
      font-size: 16px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 2px solid #bee5eb;
    }
    .step {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin: 15px 0;
    }
    .step h3 {
      margin-top: 0;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” éªŒè¯ Web App éƒ¨ç½²</h1>
    
    <div class="warning">
      <h3>âš ï¸ é‡è¦æç¤º</h3>
      <p>å¦‚æœä½ çš„ä»£ç ä¸­å·²ç»æœ‰ <code>doOptions</code> å‡½æ•°ï¼Œä½†æµ‹è¯•ä»ç„¶å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š</p>
      <ol>
        <li><strong>éƒ¨ç½²ç‰ˆæœ¬æœªæ›´æ–°</strong>ï¼šéƒ¨ç½²æ—¶é€‰æ‹©äº† "Head" è€Œä¸æ˜¯ "æ–°ç‰ˆæœ¬"</li>
        <li><strong>é“¾æ¥åˆ°é”™è¯¯çš„é¡¹ç›®</strong>ï¼šæœ‰å¤šä¸ª Google Apps Script é¡¹ç›®ï¼ŒWeb App URL æŒ‡å‘äº†é”™è¯¯çš„é¡¹ç›®</li>
        <li><strong>Web App URL é”™è¯¯</strong>ï¼šåº”ç”¨ä½¿ç”¨çš„ URL ä¸æ˜¯æœ€æ–°éƒ¨ç½²çš„ URL</li>
      </ol>
    </div>

    <div>
      <h2>å½“å‰ä½¿ç”¨çš„ Web App URL</h2>
      <p>åº”ç”¨ä»£ç ä¸­é…ç½®çš„ URLï¼š</p>
      <code id="currentUrl">https://script.google.com/macros/s/AKfycbxMZB7n-n6RGxlyBCCrXHM26fHNoHlf9d_M57Iw7tVZU1GQWm-m4BSvctHJeGZn2PAd/exec</code>
    </div>

    <div style="margin: 20px 0;">
      <button onclick="verifyDeployment()">ğŸš€ éªŒè¯å½“å‰éƒ¨ç½²</button>
      <button onclick="testAll()">ğŸ”„ å®Œæ•´æµ‹è¯•</button>
    </div>

    <div id="status" class="status info" style="display: none;"></div>
    
    <div>
      <h2>éªŒè¯ç»“æœ</h2>
      <pre id="result">ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹éªŒè¯...</pre>
    </div>

    <div id="instructions" style="display: none;">
      <h2>ğŸ“‹ ä¿®å¤æ­¥éª¤</h2>
      <div id="steps"></div>
    </div>
  </div>

  <script>
    // ä»åº”ç”¨ä»£ç ä¸­è·å–å½“å‰ä½¿ç”¨çš„ URL
    // æ³¨æ„ï¼šè¿™ä¸ª URL åº”è¯¥ä¸åº”ç”¨ä»£ç ä¸­çš„ URL ä¸€è‡´
    const API_URL = 'https://script.google.com/macros/s/AKfycbxMZB7n-n6RGxlyBCCrXHM26fHNoHlf9d_M57Iw7tVZU1GQWm-m4BSvctHJeGZn2PAd/exec';
    
    // æ˜¾ç¤ºå½“å‰ URL
    document.getElementById('currentUrl').textContent = API_URL;

    function log(message, type = 'info') {
      const resultEl = document.getElementById('result');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      resultEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      resultEl.scrollTop = resultEl.scrollHeight;
    }

    function setStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      statusEl.style.display = 'block';
    }

    function showInstructions(steps) {
      const instructionsEl = document.getElementById('instructions');
      const stepsEl = document.getElementById('steps');
      stepsEl.innerHTML = steps.map((step, index) => 
        `<div class="step">
          <h3>æ­¥éª¤ ${index + 1}: ${step.title}</h3>
          <p>${step.content}</p>
        </div>`
      ).join('');
      instructionsEl.style.display = 'block';
    }

    async function verifyDeployment() {
      document.getElementById('result').textContent = '';
      log('=== å¼€å§‹éªŒè¯ Web App éƒ¨ç½² ===');
      setStatus('æ­£åœ¨éªŒè¯...', 'info');
      
      const results = {
        get: null,
        options: null,
        post: null
      };

      // 1. æµ‹è¯• GET
      log('\n--- æµ‹è¯• 1: GET è¯·æ±‚ ---');
      try {
        const response = await fetch(API_URL, { method: 'GET' });
        const data = await response.json();
        if (data.error) {
          log(`âŒ GET å¤±è´¥: ${data.error}`, 'error');
          results.get = { success: false, error: data.error };
        } else {
          log(`âœ… GET æˆåŠŸ: è·å–åˆ° ${Array.isArray(data) ? data.length : 0} æ¡è®°å½•`, 'success');
          results.get = { success: true, count: Array.isArray(data) ? data.length : 0 };
        }
      } catch (error) {
        log(`âŒ GET å¤±è´¥: ${error.message}`, 'error');
        results.get = { success: false, error: error.message };
      }

      await new Promise(resolve => setTimeout(resolve, 1000));

      // 2. æµ‹è¯• OPTIONS
      log('\n--- æµ‹è¯• 2: OPTIONS è¯·æ±‚ï¼ˆCORS é¢„æ£€ï¼‰---');
      try {
        const response = await fetch(API_URL, { method: 'OPTIONS' });
        log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
        if (response.status === 200 || response.status === 204) {
          log('âœ… OPTIONS æˆåŠŸ: doOptions å‡½æ•°å·²æ­£ç¡®éƒ¨ç½²', 'success');
          results.options = { success: true, status: response.status };
        } else {
          log(`âŒ OPTIONS å¤±è´¥: çŠ¶æ€ç  ${response.status}`, 'error');
          log('ğŸ’¡ è¿™è¯´æ˜ doOptions å‡½æ•°æœªæ­£ç¡®éƒ¨ç½²', 'error');
          results.options = { success: false, status: response.status };
        }
      } catch (error) {
        log(`âŒ OPTIONS å¤±è´¥: ${error.message}`, 'error');
        log('ğŸ’¡ è¿™æ˜¯ CORS é”™è¯¯ï¼Œè¯´æ˜ doOptions å‡½æ•°æœªæ­£ç¡®éƒ¨ç½²', 'error');
        results.options = { success: false, error: error.message };
      }

      await new Promise(resolve => setTimeout(resolve, 1000));

      // 3. æµ‹è¯• POSTï¼ˆåªæœ‰åœ¨ OPTIONS æˆåŠŸæ—¶æ‰æµ‹è¯•ï¼‰
      if (results.options && results.options.success) {
        log('\n--- æµ‹è¯• 3: POST è¯·æ±‚ ---');
        try {
          const testData = {
            action: 'add',
            ID: 'verify-' + Date.now(),
            StartDate: '2025-12-03',
            EndDate: '2025-12-05',
            GuestsNo: 1,
            Note: 'éªŒè¯æµ‹è¯• - å¯ä»¥åˆ é™¤',
            Color: ''
          };
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testData)
          });
          const data = await response.json();
          if (data.status === 'success') {
            log('âœ… POST æˆåŠŸ: æ•°æ®å·²æ·»åŠ ', 'success');
            results.post = { success: true };
          } else {
            log(`âŒ POST å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            results.post = { success: false, error: data.error };
          }
        } catch (error) {
          log(`âŒ POST å¤±è´¥: ${error.message}`, 'error');
          results.post = { success: false, error: error.message };
        }
      } else {
        log('\n--- æµ‹è¯• 3: POST è¯·æ±‚ï¼ˆè·³è¿‡ï¼Œå› ä¸º OPTIONS å¤±è´¥ï¼‰---');
        log('ğŸ’¡ POST è¯·æ±‚éœ€è¦ OPTIONS é¢„æ£€æˆåŠŸæ‰èƒ½å·¥ä½œ', 'error');
      }

      // æ€»ç»“
      log('\n=== éªŒè¯å®Œæˆ ===');
      
      if (results.options && results.options.success && results.post && results.post.success) {
        setStatus('âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Web App éƒ¨ç½²æ­£ç¡®', 'success');
        log('âœ… ä½ çš„ Web App å·²æ­£ç¡®éƒ¨ç½²ï¼ŒåŒ…å« doOptions å‡½æ•°', 'success');
        log('âœ… åº”ç”¨åº”è¯¥å¯ä»¥æ­£å¸¸æ·»åŠ /æ›´æ–°/åˆ é™¤é¢„è®¢äº†', 'success');
      } else if (results.options && !results.options.success) {
        setStatus('âŒ OPTIONS è¯·æ±‚å¤±è´¥ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²', 'error');
        log('', 'error');
        log('ğŸ“– é—®é¢˜è¯Šæ–­ï¼š', 'error');
        log('   ä½ çš„ä»£ç ä¸­å¯èƒ½æœ‰ doOptions å‡½æ•°ï¼Œä½†éƒ¨ç½²ç‰ˆæœ¬æœªæ›´æ–°', 'error');
        log('   æˆ–è€… Web App URL æŒ‡å‘äº†é”™è¯¯çš„é¡¹ç›®', 'error');
        log('', 'error');
        
        const steps = [
          {
            title: 'ç¡®è®¤ Google Apps Script é¡¹ç›®',
            content: `1. æ‰“å¼€ Google Apps Script: https://script.google.com/<br>
                       2. ç¡®è®¤ä½ æ­£åœ¨ç¼–è¾‘çš„é¡¹ç›®æ˜¯å¦åŒ…å« doOptions å‡½æ•°<br>
                       3. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªé¡¹ç›®ï¼Œç¡®è®¤å“ªä¸ªé¡¹ç›®é“¾æ¥åˆ°äº†ä½ çš„ Google Sheet`
          },
          {
            title: 'é‡æ–°éƒ¨ç½² Web Appï¼ˆå…³é”®ï¼ï¼‰',
            content: `1. åœ¨ Google Apps Script ä¸­ï¼Œç‚¹å‡» "éƒ¨ç½²" â†’ "ç®¡ç†éƒ¨ç½²"<br>
                       2. æ‰¾åˆ°ä½ çš„ Web App éƒ¨ç½²ï¼Œç‚¹å‡» "ç¼–è¾‘"ï¼ˆé“…ç¬”å›¾æ ‡ï¼‰<br>
                       3. <strong>é‡è¦ï¼š</strong>åœ¨ "ç‰ˆæœ¬" ä¸‹æ‹‰èœå•ä¸­ï¼Œ<strong>å¿…é¡»é€‰æ‹© "æ–°ç‰ˆæœ¬"</strong>ï¼ˆä¸è¦é€‰æ‹© "Head"ï¼‰<br>
                       4. ç¡®è®¤ "å…·æœ‰è®¿é—®æƒé™çš„ç”¨æˆ·" è®¾ç½®ä¸º "æ‰€æœ‰äºº"<br>
                       5. ç‚¹å‡» "éƒ¨ç½²" æŒ‰é’®<br>
                       6. ç­‰å¾…éƒ¨ç½²å®Œæˆ`
          },
          {
            title: 'è·å–æ–°çš„ Web App URL',
            content: `1. éƒ¨ç½²å®Œæˆåï¼Œåœ¨ "ç®¡ç†éƒ¨ç½²" é¡µé¢æ‰¾åˆ° "Web app" éƒ¨åˆ†<br>
                       2. å¤åˆ¶æ–°çš„ "URL"ï¼ˆåº”è¯¥ä»¥ /exec ç»“å°¾ï¼‰<br>
                       3. å¦‚æœ URL æœ‰å˜åŒ–ï¼Œéœ€è¦æ›´æ–°åº”ç”¨ä»£ç ä¸­çš„ URL`
          },
          {
            title: 'éªŒè¯éƒ¨ç½²',
            content: `1. ç­‰å¾… 10-20 ç§’è®©éƒ¨ç½²ç”Ÿæ•ˆ<br>
                       2. åˆ·æ–°è¿™ä¸ªé¡µé¢ï¼Œé‡æ–°è¿è¡ŒéªŒè¯<br>
                       3. å¦‚æœ OPTIONS å’Œ POST éƒ½æˆåŠŸï¼Œè¯´æ˜é—®é¢˜å·²è§£å†³`
          }
        ];
        showInstructions(steps);
      } else {
        setStatus('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…', 'error');
      }
    }

    async function testAll() {
      await verifyDeployment();
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒéªŒè¯
    window.addEventListener('load', () => {
      setTimeout(() => {
        verifyDeployment();
      }, 500);
    });
  </script>
</body>
</html>

